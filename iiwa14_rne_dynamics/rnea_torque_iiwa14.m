function torque = rnea_torque_iiwa14(q, qd, qdd)
%RNEA_TORQUE_IIWA14 Compute 7-DOF iiwa14 joint torques via RNEA.
%   torque = rnea_torque_iiwa14(q, qd, qdd)

if numel(q) ~= 7 || numel(qd) ~= 7 || numel(qdd) ~= 7
    error("q, qd, qdd must be 7-element vectors.");
end

q = q(:).';
qd = qd(:).';
qdd = qdd(:).';

% Define parent indices (MATLAB indices start from 1)
parent_id_arr = [0 1 2 3 4 5 6];

% Define screw axes for each joint (7x6 matrix)
S_arr = repmat([0 0 1 0 0 0], 7, 1);

% Define inertia matrices for each link (as cell array)
Imat_arr = cell(7, 1);

Imat_arr{1} = [0.161200000000000  0.000000000000000  0.000000000000000  0.000000000000000 -0.480000000000000 -0.120000000000000;
               0.000000000000000  0.147600000000000  0.014400000000000  0.480000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.014400000000000  0.023600000000000  0.120000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.480000000000000  0.120000000000000  4.000000000000000  0.000000000000000  0.000000000000000;
              -0.480000000000000  0.000000000000000  0.000000000000000  0.000000000000000  4.000000000000000  0.000000000000000;
              -0.120000000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  4.000000000000000];

Imat_arr{2} = [0.070980000000000 -0.000070800000000 -0.000050400000000  0.000000000000000 -0.168000000000000  0.236000000000000;
              -0.000070800000000  0.025056360000000 -0.009912000000000  0.168000000000000  0.000000000000000 -0.001200000000000;
              -0.000050400000000 -0.009912000000000  0.057924360000000 -0.236000000000000  0.001200000000000  0.000000000000000;
               0.000000000000000  0.168000000000000 -0.236000000000000  4.000000000000000  0.000000000000000  0.000000000000000;
              -0.168000000000000  0.000000000000000  0.001200000000000  0.000000000000000  4.000000000000000  0.000000000000000;
               0.236000000000000 -0.001200000000000  0.000000000000000  0.000000000000000  0.000000000000000  4.000000000000000];

Imat_arr{3} = [0.078400000000000  0.000000000000000  0.000000000000000  0.000000000000000 -0.390000000000000  0.090000000000000;
               0.000000000000000  0.074500000000000 -0.011700000000000  0.390000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000 -0.011700000000000  0.010300000000000 -0.090000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.390000000000000 -0.090000000000000  3.000000000000000  0.000000000000000  0.000000000000000;
              -0.390000000000000  0.000000000000000  0.000000000000000  0.000000000000000  3.000000000000000  0.000000000000000;
               0.090000000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  3.000000000000000];

Imat_arr{4} = [0.045241500000000  0.000000000000000  0.000000000000000  0.000000000000000 -0.091800000000000  0.180900000000000;
               0.000000000000000  0.013121200000000 -0.006150600000000  0.091800000000000  0.000000000000000  0.000000000000000;
               0.000000000000000 -0.006150600000000  0.041120300000000 -0.180900000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.091800000000000 -0.180900000000000  2.700000000000000  0.000000000000000  0.000000000000000;
              -0.091800000000000  0.000000000000000  0.000000000000000  0.000000000000000  2.700000000000000  0.000000000000000;
               0.180900000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  2.700000000000000];

Imat_arr{5} = [0.030568900000000 -0.000003570000000 -0.000012920000000  0.000000000000000 -0.129200000000000  0.035700000000000;
              -0.000003570000000  0.027819217000000 -0.002713200000000  0.129200000000000  0.000000000000000 -0.000170000000000;
              -0.000012920000000 -0.002713200000000  0.005749717000000 -0.035700000000000  0.000170000000000  0.000000000000000;
               0.000000000000000  0.129200000000000 -0.035700000000000  1.700000000000000  0.000000000000000  0.000000000000000;
              -0.129200000000000  0.000000000000000  0.000170000000000  0.000000000000000  1.700000000000000  0.000000000000000;
               0.035700000000000 -0.000170000000000  0.000000000000000  0.000000000000000  0.000000000000000  1.700000000000000];

Imat_arr{6} = [0.005000936000000  0.000000000000000  0.000000000000000  0.000000000000000 -0.000720000000000  0.001080000000000;
               0.000000000000000  0.003600288000000 -0.000000432000000  0.000720000000000  0.000000000000000  0.000000000000000;
               0.000000000000000 -0.000000432000000  0.004700648000000 -0.001080000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.000720000000000 -0.001080000000000  1.800000000000000  0.000000000000000  0.000000000000000;
              -0.000720000000000  0.000000000000000  0.000000000000000  0.000000000000000  1.800000000000000  0.000000000000000;
               0.001080000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  1.800000000000000];

Imat_arr{7} = [0.001120000000000  0.000000000000000  0.000000000000000  0.000000000000000 -0.006000000000000  0.000000000000000;
               0.000000000000000  0.001120000000000  0.000000000000000  0.006000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.000000000000000  0.001000000000000  0.000000000000000  0.000000000000000  0.000000000000000;
               0.000000000000000  0.006000000000000  0.000000000000000  0.300000000000000  0.000000000000000  0.000000000000000;
              -0.006000000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.300000000000000  0.000000000000000;
               0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.000000000000000  0.300000000000000];

% Load xmat functions
xmat_func_arr = {@xmat0, @xmat1, @xmat2, @xmat3, @xmat4, @xmat5, @xmat6};

% Evaluate xmat functions and store results
n = 7;
Xmat_arr = zeros(6, 6, n);
for ind = 1:n
    Xmat_arr(:, :, ind) = xmat_func_arr{ind}(q(ind));
end

GRAVITY = 0;
[~, ~, f] = rnea_fpass(n, parent_id_arr, Xmat_arr, S_arr, Imat_arr, qd, qdd, GRAVITY);
torque = rnea_bpass(n, parent_id_arr, Xmat_arr, S_arr, f);
torque = torque(:).';
end
